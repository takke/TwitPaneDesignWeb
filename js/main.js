// „Çø„Ç§„É†„É©„Ç§„É≥„ÅÆ„Éá„Éº„Çø
const timelineData = [
  {
    id: 1,
    avatar: "https://fakeimg.pl/48x48/ddd/fff?text=T",
    userName: "„Åü„Åë„ÅÜ„Å°„Å≤„Çç„ÅÇ„Åçüêò",
    userId: "takke",
    timestamp: "2023/03/04 14:56",
    content: "@zonepane „Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åôüòä „Åì„Å°„Çâ„ÅØ Web „Åß„Éó„É¨„Éì„É•„Éº„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ",
    source: "Web",
    stars: 6
  },
  {
    id: 2,
    avatar: "https://fakeimg.pl/48x48/ddd/fff?text=Z",
    userName: "„Åù„Éº„Å∫„Çì",
    userId: "zonepane",
    timestamp: "2023/03/04 14:52",
    content: "ZonePane„ÅÆÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„Åô üòÄ",
    source: "Web",
    stars: 2
  },
  {
    id: 3,
    avatar: "https://fakeimg.pl/48x48/ddd/fff?text=Z",
    userName: "„Åù„Éº„Å∫„Çì",
    userId: "zonepane",
    timestamp: "2023/03/04 14:59",
    content: "ÁîªÂÉè„ÇíÊ∑ª‰ªò„Åô„Çã„Å®„Åì„ÅÆ„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ",
    source: "Web",
    stars: 2,
    image: "https://fakeimg.pl/600x400/ddd/fff?text=Beach+Photo"
  },
  {
    id: 4,
    avatar: "https://fakeimg.pl/48x48/ddd/fff?text=T",
    userName: "„Åü„Åë„ÅÜ„Å° „Å°„Å≤„Çç„ÅÇ„Åç",
    userId: "takke@fedibird.com",
    timestamp: "2023/03/04 15:02",
    content: "Áº∂„Éê„ÉÉ„Ç∏„Å®„Ç¢„ÇØ„Ç≠„Éº üòΩ #ZonePane",
    source: "",
    stars: 1,
    images: [
      "https://fakeimg.pl/300x300/ddd/fff?text=Badge",
      "https://fakeimg.pl/300x300/ddd/fff?text=Acrylic"
    ],
    boost: {
      user: "„Åù„Éº„Å∫„Çì",
      count: "3BT",
      icon: "https://fakeimg.pl/16x16/ddd/fff?text=Z"
    }
  }
];

// „ÉÜ„Éº„Éû„Åî„Å®„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Éê„Éº„ÉÜ„Ç≠„Çπ„Éà„Ç´„É©„Éº
const themeActionbarTextColors = {
  'Light': '000000',
  'Black': 'ffffff',
  'Paris': 'ffffff',
  'Green': 'ffffff',
  'Sakura': '000000',
  'Char': 'ffffff',
  'ResearchGreen': '000000',
  'CoralPink': '000000',
  'CafeLatte': '000000',
  'Mammoth': '000000',
  'Tai': '000000'
};

// „ÉÜ„Éº„Éû„ÅÆ„Éá„Éï„Ç©„É´„ÉàURL
const themeDefaultUrls = {
  'Light': 'https://twitpane.com/d/?theme=Light&bg=ffffff&mentionbg=f8f8f8&rtbg=f8f8f8&title=000000&date=666666&body=000000&mention=2b5c45&mytweet=2b5c45&read=666666&url=1da1f2&tab=1d9bf0&actionbar=ffffff&statusbar=333333&cw=ceb95f&more=666666',
  'Black': 'https://twitpane.com/d/?theme=Black&bg=303030&mentionbg=343440&rtbg=343440&mymsgbg=1a237e&otmsgbg=263238&title=ffffff&date=a0a0a0&body=ffffff&mention=9bc88c&mytweet=9bc88c&read=b0b0b0&url=4187aa&tab=33b5e5&actionbar=333333&statusbar=333333&cw=ceb95f&more=646869',
  'Paris': 'https://twitpane.com/d/?theme=Paris&bg=303030&mentionbg=343440&rtbg=343440&title=ffffff&date=a0a0a0&body=ffffff&mention=9bc88c&mytweet=9bc88c&read=b0b0b0&url=4187aa&tab=8e24aa&actionbar=333333&statusbar=333333&cw=ceb95f&more=646869',
  'Green': 'https://twitpane.com/d/?theme=Green&bg=303030&mentionbg=343440&rtbg=343440&title=ffffff&date=a0a0a0&body=ffffff&mention=9bc88c&mytweet=9bc88c&read=b0b0b0&url=4187aa&tab=8e24aa&actionbar=333333&statusbar=333333&cw=ceb95f&more=646869',
  'Sakura': 'https://twitpane.com/d/?theme=Sakura&bg=ffffff&mentionbg=f8f8f8&rtbg=f8f8f8&title=000000&date=666666&body=000000&mention=2b5c45&mytweet=2b5c45&read=666666&url=1da1f2&tab=1d9bf0&actionbar=ffffff&statusbar=333333&cw=ceb95f&more=666869',
  'Char': 'https://twitpane.com/d/?theme=Char&bg=303030&mentionbg=343440&rtbg=343440&title=ffffff&date=a0a0a0&body=ffffff&mention=9bc88c&mytweet=9bc88c&read=b0b0b0&url=4187aa&tab=8e24aa&actionbar=333333&statusbar=333333&cw=ceb95f&more=646869',
  'ResearchGreen': 'https://twitpane.com/d/?theme=ResearchGreen&bg=ffffff&mentionbg=f8f8f8&rtbg=f8f8f8&title=000000&date=666666&body=000000&mention=2b5c45&mytweet=2b5c45&read=666666&url=1da1f2&tab=1d9bf0&actionbar=ffffff&statusbar=333333&cw=ceb95f&more=666666',
  'CoralPink': 'https://twitpane.com/d/?theme=CoralPink&bg=ffffff&mentionbg=f8f8f8&rtbg=f8f8f8&title=000000&date=666666&body=000000&mention=2b5c45&mytweet=2b5c45&read=666666&url=1da1f2&tab=1d9bf0&actionbar=ffffff&statusbar=333333&cw=ceb95f&more=666666',
  'CafeLatte': 'https://twitpane.com/d/?theme=CafeLatte&bg=ffffff&mentionbg=f8f8f8&rtbg=f8f8f8&title=000000&date=666666&body=000000&mention=2b5c45&mytweet=2b5c45&read=666666&url=1da1f2&tab=1d9bf0&actionbar=ffffff&statusbar=333333&cw=ceb95f&more=666666',
  'Mammoth': 'https://twitpane.com/d/?theme=Mammoth&bg=ffffff&mentionbg=f8f8f8&rtbg=f8f8f8&title=000000&date=666666&body=000000&mention=2b5c45&mytweet=2b5c45&read=666666&url=1da1f2&tab=1d9bf0&actionbar=ffffff&statusbar=333333&cw=ceb95f&more=666666',
  'Tai': 'https://twitpane.com/d/?theme=Tai&bg=ffffff&mentionbg=f8f8f8&rtbg=f8f8f8&title=000000&date=666666&body=000000&mention=2b5c45&mytweet=2b5c45&read=666666&url=1da1f2&tab=1d9bf0&actionbar=ffffff&statusbar=333333&cw=ceb95f&more=666666'
};

// HTML„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
function generateTimelineHTML(posts) {
  return posts.map(post => {
    const boostHeader = post.boost ? `
      <div class="boost-header">
        <img src="${post.boost.icon}" class="boost-icon" alt="Boost Icon" />
        <span>${post.boost.user}„Åï„Çì„Åå„Éñ„Éº„Çπ„Éà„Åó„Åæ„Åó„Åü (${post.boost.count})</span>
      </div>
    ` : '';

    const images = post.images ? `
      <div class="post-images">
        ${post.images.map(img => `<img src="${img}" alt="Post image" />`).join('')}
      </div>
    ` : '';

    const singleImage = post.image ? `
      <img src="${post.image}" class="post-image" alt="Post image" />
    ` : '';

    const sourceText = post.stars ? `‚òÖ ${post.stars}${post.source ? ` ${post.source}„Åã„Çâ` : ''}` : '';

    return `
      <div class="timeline-post">
        ${boostHeader}
        <div class="d-flex">
          <div class="me-3">
            <img src="${post.avatar}" class="avatar" alt="User Avatar" />
          </div>
          <div class="flex-grow-1">
            <div class="post-header">
              <div class="user-info">
                <a href="#" class="user-name">${post.userName}</a>
                <a href="#" class="user-id">@${post.userId}</a>
              </div>
              <a href="#" class="post-time">${post.timestamp}</a>
            </div>
            <div class="post-text">${post.content}</div>
            ${singleImage}
            ${images}
            ${sourceText ? `<a href="#" class="web-source">${sourceText}</a>` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ÈÖçËâ≤„ÇíÈÅ©Áî®„Åô„ÇãÈñ¢Êï∞
function applySelectedColors() {
  const colorInputs = document.querySelectorAll('input[type="color"]');

  colorInputs.forEach(input => {
    const colorId = input.dataset.colorId;
    const value = input.value;

    // „Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£Âêç„ÇíÁîüÊàê
    const propertyName = `--${colorId.replace(/([A-Z])/g, '-$1').toLowerCase()}-color`;

    // „Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£„ÇíË®≠ÂÆö
    document.documentElement.style.setProperty(propertyName, value);
  });

  // „Ç´„É©„Éº„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
  document.getElementById('colorPreview').style.backgroundColor = document.getElementById('bgColor').value;
}

const colorMap = {
  'bg': 'bgColor',
  'mentionbg': 'mentionBgColor',
  'rtbg': 'rtBgColor',
  'title': 'titleColor',
  'date': 'dateColor',
  'body': 'bodyColor',
  'mention': 'mentionColor',
  'mytweet': 'myTweetColor',
  'read': 'readColor',
  'url': 'urlColor',
  'cw': 'cwColor',
  'more': 'moreColor',
  'statusbar': 'statusBarColor',
  'actionbar': 'actionBarColor',
  'tab': 'tabColor'
};


// URL„Åã„Çâ„Ç´„É©„Éº„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶ÈÅ©Áî®„Åô„ÇãÈñ¢Êï∞
function applyColorsFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);

  // „ÉÜ„Éº„Éû„ÅÆÂá¶ÁêÜ
  const theme = urlParams.get('theme');
  if (theme) {
    document.getElementById('themeSelect').value = theme;
    return;
  }

  // ÂêÑ„Ç´„É©„Éº„Éë„É©„É°„Éº„Çø„ÇíÂá¶ÁêÜ
  Object.entries(colorMap).forEach(([paramName, inputId]) => {
    const colorValue = urlParams.get(paramName);
    if (colorValue) {
      const input = document.getElementById(inputId);
      if (input) {
        const normalizedColor = colorValue.length === 6 ? colorValue : colorValue.padStart(6, '0');
        input.value = `#${normalizedColor}`;
      }
    }
  });

  applySelectedColors();
}

// ÁèæÂú®„ÅÆËâ≤Ë®≠ÂÆö„ÇíURL„Éë„É©„É°„Éº„Çø„Å®„Åó„Å¶ÂèñÂæó
function getColorParamsAsUrl() {
  const params = new URLSearchParams();
  document.querySelectorAll('input[type="color"]').forEach(input => {
    const colorId = input.dataset.colorId;
    const value = input.value.substring(1); // #„ÇíÈô§Âéª
    params.append(colorId, value);
  });
  return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
}

// „ÉÜ„Éº„Éû„ÇíÈÅ©Áî®„Åô„ÇãÈñ¢Êï∞ÔºàURL„Åã„Çâ„É≠„Éº„ÉâÔºâ
function applyThemeFromUrl(themeName) {
  const themeUrl = themeDefaultUrls[themeName];
  if (!themeUrl) return;

  // URL„Åã„Çâ„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó
  const url = new URL(themeUrl);
  const params = new URLSearchParams(url.search);

  // ÂêÑ„Ç´„É©„Éº„Éë„É©„É°„Éº„Çø„ÇíÈÅ©Áî®
  Object.entries(colorMap).forEach(([paramName, inputId]) => {
    const colorValue = params.get(paramName);
    if (colorValue) {
      const input = document.getElementById(inputId);
      if (input) {
        const normalizedColor = colorValue.length === 6 ? colorValue : colorValue.padStart(6, '0');
        input.value = `#${normalizedColor}`;
      }
    }
  });

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éê„Éº„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç´„É©„Éº„ÇíË®≠ÂÆö
  const actionbarTextColor = themeActionbarTextColors[themeName] || '000000';
  document.documentElement.style.setProperty('--actionbar-text-color', `#${actionbarTextColor}`);

  applySelectedColors();
}

document.addEventListener('DOMContentLoaded', function () {
  // „Çø„Ç§„É†„É©„Ç§„É≥„ÅÆÂàùÊúüË°®Á§∫
  const timelineContainer = document.querySelector('.timeline');
  timelineContainer.innerHTML = generateTimelineHTML(timelineData);

  // ÂêÑ„Ç´„É©„ÉºÂÖ•Âäõ„Å´Âç≥ÊôÇÂèçÊò†„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
  document.querySelectorAll('input[type="color"]').forEach(input => {
    input.addEventListener('input', () => {
      applySelectedColors();
      // URL„ÇíÊõ¥Êñ∞Ôºà„Åü„Å†„Åó„Éö„Éº„Ç∏ÈÅ∑Áßª„ÅØ„Åó„Å™„ÅÑÔºâ
      const newUrl = getColorParamsAsUrl();
      window.history.replaceState({}, '', newUrl);
    });
  });

  // ÈÖçËâ≤„ÇíÈÅ©Áî®„Éú„Çø„É≥„Å´„ÇÇ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
  document.querySelector('.btn-primary').addEventListener('click', applySelectedColors);

  // „ÉÜ„Éº„Éû„ÅÆÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†
  const themeSelect = document.getElementById('themeSelect');
  themeSelect.innerHTML = ''; // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢

  // „Éá„Éï„Ç©„É´„Éà„ÅÆLight„ÉÜ„Éº„Éû„ÇíËøΩÂä†
  const defaultOption = document.createElement('option');
  defaultOption.value = 'Light';
  defaultOption.textContent = 'Light';
  themeSelect.appendChild(defaultOption);

  // „Åù„ÅÆ‰ªñ„ÅÆ„ÉÜ„Éº„Éû„ÇíËøΩÂä†
  [
    ['Black', 'Dark'],
    ['Paris', 'Paris(D)'],
    ['Green', 'Green(D)'],
    ['Sakura', 'Sakura(L)'],
    ['Char', 'Char(D)'],
    ['ResearchGreen', 'ResearchGreen(L)'],
    ['CoralPink', 'CoralPink(L)'],
    ['CafeLatte', 'CafeLatte(L)'],
    ['Mammoth', 'Mammoth(L)'],
    ['Tai', 'Tai(L)']
  ].forEach(([value, text]) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = text;
    themeSelect.appendChild(option);
  });

  // „ÉÜ„Éº„ÉûÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ
  themeSelect.addEventListener('change', (e) => {
    const value = e.target.value;
    const prevValue = e.target.dataset.prevValue || 'Light';

    if (!value) {
      e.target.value = prevValue;
      return;
    }

    // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
    if (confirm('„ÉÜ„Éº„Éû„ÇíÂ§âÊõ¥„Åô„Çã„Å®ÁèæÂú®„ÅÆËâ≤Ë®≠ÂÆö„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åô„ÄÇ\n„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
      // „ÉÜ„Éº„Éû„ÅÆ„Éá„Éï„Ç©„É´„ÉàURL„ÇíÂèñÂæó„Åó„Å¶ÈÅ∑Áßª
      const themeUrl = themeDefaultUrls[value];
      if (themeUrl) {
        window.location.href = themeUrl;
      }
    } else {
      // „Ç≠„É£„É≥„Çª„É´„Åó„ÅüÂ†¥Âêà„ÅØÂâç„ÅÆÂÄ§„Å´Êàª„Åô
      e.target.value = prevValue;
    }
  });

  // URL„Åã„Çâ„ÉÜ„Éº„Éû„ÇíÂèñÂæó„ÄÅ„Å™„Åë„Çå„Å∞Light„ÇíË®≠ÂÆö
  const urlParams = new URLSearchParams(window.location.search);
  const theme = urlParams.get('theme') || 'Light';

  // „ÉÜ„Éº„Éû„Çª„É¨„ÇØ„Éà„ÅÆÂàùÊúüÂÄ§„ÇíË®≠ÂÆö
  themeSelect.value = theme;
  themeSelect.dataset.prevValue = theme;

  // „ÉÜ„Éº„Éû„ÅÆ„Éá„Éï„Ç©„É´„ÉàURL„Åã„ÇâËâ≤„ÇíÈÅ©Áî®
  if (themeDefaultUrls[theme]) {
    applyThemeFromUrl(theme);
  } else {
    applyColorsFromUrl();
  }
});
